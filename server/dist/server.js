/*! For license information please see server.js.LICENSE.txt */
(()=>{var e={37:e=>{"use strict";e.exports=require("mongoose")},252:e=>{"use strict";e.exports=require("express")},437:e=>{"use strict";e.exports=require("socket.io")},577:e=>{"use strict";e.exports=require("cors")},596:(e,t,r)=>{var n=r(37),o=new n.Schema({username:{type:String,required:!0,unique:!0,trim:!0},email:{type:String,required:!0,unique:!0,trim:!0,lowercase:!0},password:{type:String,required:!0},createdAt:{type:Date,default:Date.now},lastSeen:{type:Date,default:Date.now}});e.exports=n.model("User",o)},611:e=>{"use strict";e.exports=require("http")},620:(e,t,r)=>{var n=r(37),o=new n.Schema({name:{type:String,required:!0,unique:!0,trim:!0},description:{type:String,trim:!0},createdBy:{type:n.Schema.Types.ObjectId,ref:"User",required:!0},members:[{type:n.Schema.Types.ObjectId,ref:"User"}],createdAt:{type:Date,default:Date.now},lastActivity:{type:Date,default:Date.now},isPrivate:{type:Boolean,default:!1}});e.exports=n.model("Room",o)},729:e=>{"use strict";e.exports=require("bcryptjs")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},952:(e,t,r)=>{var n=r(37),o=new n.Schema({content:{type:String,required:!0,trim:!0},user:{type:n.Schema.Types.ObjectId,ref:"User",required:!0},room:{type:String,required:!0,trim:!0},timestamp:{type:Date,default:Date.now},type:{type:String,enum:["text","image","file"],default:"text"},metadata:{type:n.Schema.Types.Mixed}});e.exports=n.model("Message",o)}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,r),a.exports}function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function o(){"use strict";o=function(){return t};var e,t={},r=Object.prototype,a=r.hasOwnProperty,s=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},c=i.iterator||"@@iterator",u=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function p(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{p({},"")}catch(e){p=function(e,t,r){return e[t]=r}}function f(e,t,r,n){var o=t&&t.prototype instanceof w?t:w,a=Object.create(o.prototype),i=new P(n||[]);return s(a,"_invoke",{value:_(e,r,i)}),a}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=f;var m="suspendedStart",d="suspendedYield",v="executing",y="completed",g={};function w(){}function x(){}function b(){}var k={};p(k,c,(function(){return this}));var j=Object.getPrototypeOf,S=j&&j(j(D([])));S&&S!==r&&a.call(S,c)&&(k=S);var E=b.prototype=w.prototype=Object.create(k);function L(e){["next","throw","return"].forEach((function(t){p(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function r(o,s,i,c){var u=h(e[o],e,s);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==n(p)&&a.call(p,"__await")?t.resolve(p.__await).then((function(e){r("next",e,i,c)}),(function(e){r("throw",e,i,c)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,c)}))}c(u.arg)}var o;s(this,"_invoke",{value:function(e,n){function a(){return new t((function(t,o){r(e,n,t,o)}))}return o=o?o.then(a,a):a()}})}function _(t,r,n){var o=m;return function(a,s){if(o===v)throw Error("Generator is already running");if(o===y){if("throw"===a)throw s;return{value:e,done:!0}}for(n.method=a,n.arg=s;;){var i=n.delegate;if(i){var c=q(i,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===m)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=v;var u=h(t,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===g)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function q(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,q(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var a=h(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,g;var s=a.arg;return s?s.done?(r[t.resultName]=s.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function U(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function D(t){if(t||""===t){var r=t[c];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,s=function r(){for(;++o<t.length;)if(a.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return s.next=s}}throw new TypeError(n(t)+" is not iterable")}return x.prototype=b,s(E,"constructor",{value:b,configurable:!0}),s(b,"constructor",{value:x,configurable:!0}),x.displayName=p(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,p(e,l,"GeneratorFunction")),e.prototype=Object.create(E),e},t.awrap=function(e){return{__await:e}},L(O.prototype),p(O.prototype,u,(function(){return this})),t.AsyncIterator=O,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var s=new O(f(e,r,n,o),a);return t.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},L(E),p(E,l,"Generator"),p(E,c,(function(){return this})),p(E,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=D,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(U),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function n(n,o){return i.type="throw",i.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],i=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var c=a.call(s,"catchLoc"),u=a.call(s,"finallyLoc");if(c&&u){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&a.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),U(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;U(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:D(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function a(e,t,r,n,o,a,s){try{var i=e[a](s),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}function s(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var s=e.apply(t,r);function i(e){a(s,n,o,i,c,"next",e)}function c(e){a(s,n,o,i,c,"throw",e)}i(void 0)}))}}var i=r(252),c=r(611),u=r(437),l=r(577),p=r(37),f=r(729),h=r(829),m=r(596),d=r(952),v=r(620),y=i();y.use(l()),y.use(i.json());var g=c.createServer(y),w=u(g,{cors:{origin:"http://localhost:4200",methods:["GET","POST"],credentials:!0},transports:["websocket","polling"],allowEIO3:!0,pingTimeout:6e4,pingInterval:25e3});!function(){var e=s(o().mark((function e(){var t,r;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,p.connect("mongodb://localhost:27017/chatapp",{useNewUrlParser:!0,useUnifiedTopology:!0,serverSelectionTimeoutMS:5e3,retryWrites:!0,w:"majority"});case 3:return t=e.sent,console.log("MongoDB Connected: ".concat(t.connection.host)),e.t0=m,e.next=8,f.hash("test123",10);case 8:return e.t1=e.sent,e.t2={username:"test",email:"test@test.com",password:e.t1},r=new e.t0(e.t2),e.next=13,r.save();case 13:return console.log("Test user created successfully"),e.next=16,m.deleteOne({email:"test@test.com"});case 16:console.log("Test user cleaned up"),e.next=23;break;case 19:e.prev=19,e.t3=e.catch(0),console.error("MongoDB connection error:",e.t3),process.exit(1);case 23:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(){return e.apply(this,arguments)}}()();var x=function(e,t,r){var n=e.headers.authorization,o=n&&n.split(" ")[1];if(!o)return t.status(401).json({error:"Access token required"});h.verify(o,"your-secret-key",(function(n,o){if(n)return t.status(403).json({error:"Invalid token"});e.user=o,r()}))};y.post("/api/register",function(){var e=s(o().mark((function e(t,r){var n,a,s,i,c,u,l;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.body,a=n.username,s=n.email,i=n.password,e.next=4,m.findOne({$or:[{email:s},{username:a}]});case 4:if(!e.sent){e.next=7;break}return e.abrupt("return",r.status(400).json({error:"User already exists"}));case 7:return e.next=9,f.hash(i,10);case 9:return c=e.sent,u=new m({username:a,email:s,password:c}),e.next=13,u.save();case 13:l=e.sent,console.log("New user registered:",l.username),r.status(201).json({message:"User created successfully",userId:l._id}),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(0),console.error("Registration error:",e.t0),r.status(400).json({error:e.t0.message});case 22:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(t,r){return e.apply(this,arguments)}}()),y.post("/api/login",function(){var e=s(o().mark((function e(t,r){var n,a,s,i,c,u;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log(t.body),a=JSON.parse(null===(n=t.body)||void 0===n?void 0:n.param),console.log(a),s=a.email,i=a.password,console.log("email",s),e.next=8,m.findOne({email:s});case 8:if(c=e.sent){e.next=11;break}return e.abrupt("return",r.status(400).json({error:"User not found"}));case 11:return e.next=13,f.compare(i,c.password);case 13:if(e.sent){e.next=16;break}return e.abrupt("return",r.status(400).json({error:"Invalid password"}));case 16:return c.lastSeen=new Date,e.next=19,c.save();case 19:u=h.sign({id:c._id,username:c.username},"your-secret-key"),console.log("User logged in:",c.username),r.json({token:u,user:{_id:c._id,username:c.username,email:c.email}}),e.next=28;break;case 24:e.prev=24,e.t0=e.catch(0),console.error("Login error:",e.t0),r.status(400).json({error:e.t0.message});case 28:case"end":return e.stop()}}),e,null,[[0,24]])})));return function(t,r){return e.apply(this,arguments)}}()),y.post("/api/rooms",x,function(){var e=s(o().mark((function e(t,r){var n,a,s,i,c,u;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.body,a=n.name,s=n.description,i=n.isPrivate,e.next=4,v.findOne({name:a});case 4:if(!e.sent){e.next=7;break}return e.abrupt("return",r.status(400).json({error:"Room already exists"}));case 7:return c=new v({name:a,description:s,createdBy:t.user.id,members:[t.user.id],isPrivate:i}),e.next=10,c.save();case 10:u=e.sent,console.log("New room created:",u.name),r.status(201).json(u),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("Room creation error:",e.t0),r.status(400).json({error:e.t0.message});case 19:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,r){return e.apply(this,arguments)}}()),y.get("/api/rooms",x,function(){var e=s(o().mark((function e(t,r){var n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,v.find({$or:[{isPrivate:!1},{members:t.user.id}]}).populate("createdBy","username");case 3:n=e.sent,console.log("Rooms fetched for user:",t.user.username),r.json(n),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("Error fetching rooms:",e.t0),r.status(400).json({error:e.t0.message});case 12:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,r){return e.apply(this,arguments)}}()),w.use(function(){var e=s(o().mark((function e(t,r){var n,a,s;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("Received query:",t.handshake.query),e.prev=1,n=t.handshake.query.token){e.next=5;break}return e.abrupt("return",r(new Error("Authentication error")));case 5:return console.log("token passed"),a=h.verify(n,"your-secret-key"),e.next=9,m.findById(a.id);case 9:if(s=e.sent){e.next=12;break}return e.abrupt("return",r(new Error("User not found")));case 12:t.user=s,r(),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(1),r(new Error("Authentication error"));case 19:case"end":return e.stop()}}),e,null,[[1,16]])})));return function(t,r){return e.apply(this,arguments)}}()),w.on("connection",(function(e){console.log("User connected:",e.user.username),e.on("join-room",function(){var t=s(o().mark((function t(r){var n;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("User ".concat(e.user.username," joined room: ").concat(r)),e.join(r),t.prev=2,t.next=5,d.find({room:r}).sort({timestamp:1}).limit(50).populate("user","username email");case 5:n=t.sent,console.log("Fetched ".concat(n.length," messages for room: ").concat(r)),e.emit("room-messages",n),t.next=14;break;case 10:t.prev=10,t.t0=t.catch(2),console.error("Error fetching room messages:",t.t0),e.emit("error",{message:"Failed to fetch messages"});case 14:case"end":return t.stop()}}),t,null,[[2,10]])})));return function(e){return t.apply(this,arguments)}}()),e.on("leave-room",(function(t){console.log("User ".concat(e.user.username," left room: ").concat(t)),e.leave(t)})),e.on("message",function(){var t=s(o().mark((function t(r){var n,a,s;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("Message received:",r),t.prev=1,n=new d({content:r.content,user:e.user._id,room:r.room,type:r.type||"text",metadata:r.metadata}),t.next=5,n.save();case 5:return a=t.sent,console.log("Message saved:",a._id),t.next=9,v.findOneAndUpdate({name:r.room},{lastActivity:new Date});case 9:return t.next=11,d.findById(a._id).populate("user","username email");case 11:s=t.sent,w.to(r.room).emit("message",s),t.next=19;break;case 15:t.prev=15,t.t0=t.catch(1),console.error("Error saving message:",t.t0),e.emit("error",{message:"Failed to save message"});case 19:case"end":return t.stop()}}),t,null,[[1,15]])})));return function(e){return t.apply(this,arguments)}}()),e.on("get-room-messages",function(){var t=s(o().mark((function t(r){var n;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,d.find({room:r}).sort({timestamp:1}).limit(50).populate("user","username email");case 3:n=t.sent,console.log("Fetched ".concat(n.length," messages for room: ").concat(r)),e.emit("room-messages",n),t.next=12;break;case 8:t.prev=8,t.t0=t.catch(0),console.error("Error fetching room messages:",t.t0),e.emit("error",{message:"Failed to fetch messages"});case 12:case"end":return t.stop()}}),t,null,[[0,8]])})));return function(e){return t.apply(this,arguments)}}()),e.on("disconnect",s(o().mark((function t(){return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("User disconnected:",e.user.username),t.prev=1,t.next=4,m.findByIdAndUpdate(e.user._id,{lastSeen:new Date});case 4:console.log("Updated last seen for user:",e.user.username),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(1),console.error("Error updating user last seen:",t.t0);case 10:case"end":return t.stop()}}),t,null,[[1,7]])}))))}));var b=process.env.PORT||3e3;g.listen(b,(function(){console.log("Server running on port ".concat(b))}))})();